#!/bin/bash

COBALT_BIN_DIR=$(dirname $(test -L "$0" && readlink "$0" || echo "$0"))
PROJECT_ROOT_DIR=$(pwd)
PROJECT_CACHE_DIR=$(${COBALT_BIN_DIR}/getcachedir.sh)

# Check if the project root directory contains a Cobalt project file
if [ ! -f "${PROJECT_ROOT_DIR}/cobalt.json" ]; then
    echo "ERROR: No Cobalt project file found in ${PROJECT_ROOT_DIR}"
    exit 2
fi

# Build project cache, if necessary
export COBALT_BIN_DIR PROJECT_ROOT_DIR PROJECT_CACHE_DIR; make -s --directory "${PROJECT_ROOT_DIR}" -f "${COBALT_BIN_DIR}/project.makefile"

# Build the sources
export COBALT_BIN_DIR; make -s --directory "${PROJECT_ROOT_DIR}" -f "${PROJECT_CACHE_DIR}/cobalt" $*
